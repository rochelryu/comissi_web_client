server {
    listen 80 ;
    listen [::]:80 ;
    root /var/www/html/everykid_app;
	index index.php;

    access_log /var/log/nginx/preprod.nearteam.fr.access.log;
    error_log /var/log/nginx/preprod.nearteam.fr.error.log;

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location / {
	allow IP_à_activer;
	allow 196.203.207.137;
	deny all;

        try_files $uri $uri/ /index.php?$args;

        # Augmenter les buffers pour cette location
        fastcgi_buffers 16 128k;
        fastcgi_buffer_size 256k;
        proxy_read_timeout 300s; # Augmentation du timeout à 300s
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php7.2-fpm.sock;
        proxy_read_timeout 300s; # Augmentation du timeout à 300s
    }

    location /boutique/ckomshop/index.php {
        try_files $uri $uri/ /boutique/ckomshop/index.php?$args;
        proxy_read_timeout 300s; # Augmentation du timeout à 300s
        fastcgi_buffers 16 128k;
        fastcgi_buffer_size 256k;

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/run/php/php7.2-fpm.sock;

            # Augmenter les buffers pour cette location
            fastcgi_buffers 16 128k;
            fastcgi_buffer_size 256k;
            proxy_read_timeout 300s; # Augmentation du timeout à 300s
        }
    }

    location /boutique {
	allow IP_à_activer;
	allow 196.203.207.137;
	deny all;

        try_files $uri $uri/ /boutique/index.php?$args;

        # Augmenter les buffers pour cette location
        fastcgi_buffers 16 128k;
        fastcgi_buffer_size 256k;
        proxy_read_timeout 300s; # Augmentation du timeout à 300s

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/run/php/php7.2-fpm.sock;
            proxy_read_timeout 300s; # Augmentation du timeout à 300s

        }
        # Also do the friendly URL rewrites
        location ~* \.(eot|gif|ico|jpg|jpeg|otf|pdf|png|svg|swf|ttf|woff)$ {
            rewrite ^/boutique/([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$1$2$3.jpg break;
            rewrite ^/boutique/([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$1$2$3$4.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$1$2$3$4$5.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$4/$1$2$3$4$5$6.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$4/$5/$1$2$3$4$5$6$7.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$4/$5/$6/$1$2$3$4$5$6$7$8.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$4/$5/$6/$7/$1$2$3$4$5$6$7$8$9.jpg break;
            rewrite ^/boutique/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /boutique/img/p/$1/$2/$3/$4/$5/$6/$7/$8/$1$2$3$4$5$6$7$8$9$10.jpg break;
            rewrite ^/boutique/c/([0-9]+)(\-[\.*_a-zA-Z0-9-]*)(-[0-9]+)?/.+\.jpg$ /boutique/img/c/$1$2$3.jpg break;
            rewrite ^/boutique/c/([a-zA-Z_-]+)(-[0-9]+)?/.+\.jpg$ /boutique/img/c/$1$2.jpg break;
            rewrite ^/boutique/images_ie/?([^/]+)\.(jpe?g|png|gif)$ /boutique/js/jquery/plugins/fancybox/images/$1.$2 break;
            # next line is PSCSX-2790 bug workaround, fixed in 1.6.0.10
            rewrite ^/[a-zA-Z]+/img/cms/(.*)$ /boutique/img/cms/$1 break;
            expires 1M;
            add_header Cache-Control public;
            allow all;
        }

    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires max;
        log_not_found off;
    }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/preprod.nearteam.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/preprod.nearteam.fr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}


server {
    listen 80 ;
    listen [::]:80 ;
    root /var/www/html/everykid_app/boutique;
    server_name ekpro.nearteam.fr; # managed by Certbot
    index index.php;        
        
    access_log /var/log/nginx/ekpro.nearteam.fr.access.log;
    error_log /var/log/nginx/ekpro.nearteam.fr.error.log;

    location = /favicon.ico {
        log_not_found off;
        access_log off;
    }

    location = /robots.txt {
        allow all;
        log_not_found off;
        access_log off;
    }

    location / {
	allow IP_à_activer;
	allow 196.203.207.137;
	deny all;
        try_files $uri $uri/ /index.php?$args;

        # Augmenter les buffers pour cette location
        fastcgi_buffers 16 128k;
        fastcgi_buffer_size 256k;
        proxy_read_timeout 300s; # Augmentation du timeout à 300s

        location ~ \.php$ {
            include snippets/fastcgi-php.conf;
            fastcgi_pass unix:/run/php/php7.2-fpm.sock;
            proxy_read_timeout 300s; # Augmentation du timeout à 300s
        }
    }

    location ~* \.(eot|gif|ico|jpg|jpeg|otf|pdf|png|svg|swf|ttf|woff)$ {
        rewrite ^/([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$1$2$3.jpg break;
        rewrite ^/([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$1$2$3$4.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$1$2$3$4$5.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$4/$1$2$3$4$5$6.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$4/$5/$1$2$3$4$5$6$7.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$1$2$3$4$5$6$7$8.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$7/$1$2$3$4$5$6$7$8$9.jpg break;
        rewrite ^/([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])([0-9])(\-[_a-zA-Z0-9-]*)?(-[0-9]+)?/.+\.jpg$ /img/p/$1/$2/$3/$4/$5/$6/$7/$8/$1$2$3$4$5$6$7$8$9$10.jpg break;
        rewrite ^/c/([0-9]+)(\-[\.*_a-zA-Z0-9-]*)(-[0-9]+)?/.+\.jpg$ /img/c/$1$2$3.jpg break;
        rewrite ^/c/([a-zA-Z_-]+)(-[0-9]+)?/.+\.jpg$ /img/c/$1$2.jpg break;
        rewrite ^/images_ie/?([^/]+)\.(jpe?g|png|gif)$ /js/jquery/plugins/fancybox/images/$1.$2 break;
        # next line is PSCSX-2790 bug workaround, fixed in 1.6.0.10
        rewrite ^/[a-zA-Z]+/img/cms/(.*)$ /img/cms/$1 break;
        expires 1M;
        add_header Cache-Control public;
        allow all;
    }

    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires max;
        log_not_found off;
    }

    listen [::]:443 ssl; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/ekpro.nearteam.fr/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/ekpro.nearteam.fr/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
}